---
import Layout from "../../../layouts/Layout.astro";
import Card from "../../../components/Card.astro";
import Input from "../../../components/Input.astro";
import Button from "../../../components/Button.astro";

const title = "Stamp duty calculator (UK) — All The Calculators";
const description =
  "Estimate Stamp Duty Land Tax (SDLT) for residential property purchases in England.";
---

<Layout title={title} description={description}>
  <div class="space-y-6">
    <header>
      <h1 class="text-2xl font-semibold tracking-tight">Stamp duty calculator</h1>
      <p class="mt-2 text-sm text-[rgb(var(--muted))] max-w-2xl">
        Estimate Stamp Duty Land Tax (SDLT) on residential property purchases in England.
      </p>
    </header>

    <section class="inputs-container space-y-4" aria-label="Stamp duty inputs">
      <div class="inputs-grid">
        <div>
          <Input
            id="price"
            label="Property price (£)"
            type="number"
            inputmode="decimal"
            min="0"
            step="1"
            placeholder="e.g. 425000"
          />
          <p id="price-error" class="mt-1 hidden text-xs text-red-600"></p>
        </div>

        <div class="md:col-span-2">
          <div class="mb-1 text-sm font-medium text-[rgb(var(--text))]">Buyer type</div>
          <select
            id="buyerType"
            class="w-full rounded-xl border border-[rgb(var(--border))] bg-white px-3 py-2 text-sm text-[rgb(var(--text))] focus:outline-none focus:ring-2 focus:ring-black/10"
          >
            <option value="standard" selected>Standard residential purchase</option>
            <option value="firstTime">First-time buyer</option>
            <option value="additional">Additional property (higher rates)</option>
          </select>
        </div>
      </div>

      <div class="flex flex-wrap gap-3 pt-1">
        <Button type="button" id="calcBtn">Calculate</Button>
        <Button type="button" variant="ghost" id="resetBtn">Reset</Button>
      </div>

      <p class="text-xs text-[rgb(var(--muted))]">
        Assumes England SDLT residential bands and a simple first-time buyer/additional property treatment.
      </p>
    </section>

    <hr class="border-t border-[rgb(var(--border))]" />

    <section aria-label="Stamp duty results" class="space-y-4">
      <header>
        <h2 class="text-[18px] font-semibold tracking-tight">Results</h2>
        <p class="mt-1 text-[14px] text-[rgb(var(--muted))]">These are estimates based on your inputs.</p>
      </header>

      <div class="results-grid" role="status" aria-live="polite" aria-atomic="true">
        <Card>
          <div class="text-xs font-medium uppercase tracking-wide text-[rgb(var(--muted))]">Estimated SDLT</div>
          <div class="mt-1 text-[18px] font-semibold tracking-tight" id="sdlt">—</div>
        </Card>

        <Card>
          <div class="text-xs font-medium uppercase tracking-wide text-[rgb(var(--muted))]">Effective tax rate</div>
          <div class="mt-1 text-[18px] font-semibold tracking-tight" id="rate">—</div>
        </Card>

        <Card>
          <div class="text-xs font-medium uppercase tracking-wide text-[rgb(var(--muted))]">Total cash needed</div>
          <div class="mt-1 text-[18px] font-semibold tracking-tight" id="total">—</div>
        </Card>
      </div>
    </section>

    <hr class="border-t border-[rgb(var(--border))]" />

    <section class="max-w-2xl" aria-label="How this calculator works">
      <details class="group">
        <summary
          class="flex cursor-pointer list-none items-center gap-2 py-2 text-sm font-semibold tracking-tight focus:outline-none focus-visible:ring-2 focus-visible:ring-black/20 rounded-lg"
        >
          <span
            class="inline-flex h-4 w-4 items-center justify-center text-[rgb(var(--muted))] transition-transform group-open:rotate-90"
            aria-hidden="true"
          >
            <svg viewBox="0 0 20 20" width="16" height="16" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M7.25 4.75L12.75 10L7.25 15.25" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
          </span>
          <span>How this calculator works</span>
        </summary>

        <div class="pt-2 pl-6 space-y-2 text-sm text-[rgb(var(--muted))]">
          <p>
            SDLT is charged in bands. Each part of the property price is taxed at the relevant rate for that band.
          </p>
          <p>
            First-time buyer relief and additional property surcharges are applied with simplified assumptions.
          </p>
        </div>
      </details>
    </section>

    <section class="max-w-2xl space-y-6" aria-label="Stamp duty guide">
      <div>
        <h2 class="text-[18px] font-semibold tracking-tight">What this calculator does</h2>
        <p class="mt-2 text-sm text-[rgb(var(--muted))]">
          This calculator estimates stamp duty for residential purchases in England. It can model a standard purchase,
          first-time buyer relief, and additional property rates.
        </p>
        <p class="mt-2 text-sm text-[rgb(var(--muted))]">
          Use it early when planning a move to understand the upfront tax cost alongside deposit and fees.
        </p>
      </div>

      <div>
        <h2 class="text-[18px] font-semibold tracking-tight">How the formula works</h2>
        <p class="mt-2 text-sm text-[rgb(var(--muted))]">
          We split your property price across tax bands and apply the relevant rate to each band portion. For additional
          properties, a surcharge is added to each band.
        </p>
        <p class="mt-2 text-sm text-[rgb(var(--muted))]">
          For first-time buyers, relief is applied in line with current threshold rules in this simplified model.
        </p>
      </div>

      <div>
        <h2 class="text-[18px] font-semibold tracking-tight">Worked example</h2>
        <p class="mt-2 text-sm text-[rgb(var(--muted))]">
          Example: purchase price £425,000 as a first-time buyer. A larger portion of the price may be taxed at reduced
          or zero rates compared with a standard buyer, reducing SDLT.
        </p>
        <p class="mt-2 text-sm text-[rgb(var(--muted))]">
          If the same property is an additional purchase, surcharge rates can increase SDLT substantially.
        </p>
      </div>

      <div>
        <h2 class="text-[18px] font-semibold tracking-tight">Common mistakes</h2>
        <ul class="mt-2 list-disc pl-5 text-sm text-[rgb(var(--muted))] space-y-1">
          <li>Applying one tax rate to the whole property price.</li>
          <li>Forgetting additional property surcharges.</li>
          <li>Using the wrong UK nation (rules differ outside England).</li>
          <li>Ignoring legal and mortgage fees in total moving costs.</li>
        </ul>
      </div>

      <div>
        <h2 class="text-[18px] font-semibold tracking-tight">When to use this calculator</h2>
        <p class="mt-2 text-sm text-[rgb(var(--muted))]">
          Use this when comparing properties, budgeting for a purchase, or deciding whether to buy as an additional
          property. For monthly costs, use the Mortgage payment calculator.
        </p>
      </div>

      <div>
        <h2 class="text-[18px] font-semibold tracking-tight">FAQs</h2>
        <div class="mt-2 space-y-3 text-sm text-[rgb(var(--muted))]">
          <div>
            <h3 class="font-semibold text-[rgb(var(--text))]">Does this include all exemptions?</h3>
            <p class="mt-1">
              No. It is a practical estimate and does not cover every exemption, relief, or edge case.
            </p>
          </div>
          <div>
            <h3 class="font-semibold text-[rgb(var(--text))]">Is this valid for Scotland and Wales?</h3>
            <p class="mt-1">
              No. Scotland (LBTT) and Wales (LTT) use different systems.
            </p>
          </div>
          <div>
            <h3 class="font-semibold text-[rgb(var(--text))]">Should I use this before making an offer?</h3>
            <p class="mt-1">
              Yes. It helps estimate total upfront cash required.
            </p>
          </div>
        </div>
      </div>

      <div>
        <h2 class="text-[18px] font-semibold tracking-tight">Related calculators</h2>
        <ul class="mt-2 list-disc pl-5 text-sm text-[rgb(var(--muted))] space-y-1">
          <li><a class="underline" href="/calculators/mortgage-payment">Mortgage payment calculator</a></li>
          <li><a class="underline" href="/calculators/mortgage-affordability">Mortgage affordability calculator</a></li>
          <li><a class="underline" href="/calculators/savings-goal">Savings goal calculator</a></li>
        </ul>
      </div>
    </section>
  </div>

  <script is:inline>
    const fmtGBP = new Intl.NumberFormat("en-GB", { style: "currency", currency: "GBP" });
    const fmtPct = new Intl.NumberFormat("en-GB", { maximumFractionDigits: 2 });

    const fields = {
      price: document.getElementById("price"),
      buyerType: document.getElementById("buyerType"),
    };
    const errors = {
      price: document.getElementById("price-error"),
    };

    function setBlankResults() {
      document.getElementById("sdlt").textContent = "—";
      document.getElementById("rate").textContent = "—";
      document.getElementById("total").textContent = "—";
    }

    function showError(key, msg) {
      const input = fields[key];
      const err = errors[key];
      if (!input || !err) return;
      input.setAttribute("aria-invalid", "true");
      input.setAttribute("aria-describedby", `${key}-error`);
      input.classList.add("border-red-500");
      err.textContent = msg;
      err.classList.remove("hidden");
    }

    function clearError(key) {
      const input = fields[key];
      const err = errors[key];
      if (!input || !err) return;
      input.removeAttribute("aria-invalid");
      if (input.getAttribute("aria-describedby") === `${key}-error`) input.removeAttribute("aria-describedby");
      input.classList.remove("border-red-500");
      err.textContent = "";
      err.classList.add("hidden");
    }

    function parseNumber(el) {
      const v = String(el?.value ?? "").trim();
      if (v === "") return null;
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    }

    function bandedTax(amount, bands, surcharge = 0) {
      let remaining = amount;
      let prevLimit = 0;
      let tax = 0;

      for (const band of bands) {
        if (remaining <= 0) break;
        const bandLimit = band.limit;
        const taxable = Math.max(0, Math.min(amount, bandLimit) - prevLimit);
        tax += taxable * (band.rate + surcharge);
        prevLimit = bandLimit;
        remaining = amount - bandLimit;
      }

      if (remaining > 0) {
        const top = bands[bands.length - 1];
        tax += remaining * (top.rate + surcharge);
      }
      return tax;
    }

    function calculateSdlt(price, buyerType) {
      // Simplified England residential bands (current style)
      const standardBands = [
        { limit: 250000, rate: 0.00 },
        { limit: 925000, rate: 0.05 },
        { limit: 1500000, rate: 0.10 },
        { limit: Number.POSITIVE_INFINITY, rate: 0.12 },
      ];

      if (buyerType === "additional") {
        return bandedTax(price, standardBands, 0.03);
      }

      if (buyerType === "firstTime") {
        if (price > 625000) return bandedTax(price, standardBands, 0);
        const ftbBands = [
          { limit: 425000, rate: 0.00 },
          { limit: 625000, rate: 0.05 },
          { limit: Number.POSITIVE_INFINITY, rate: 0.12 },
        ];
        return bandedTax(price, ftbBands, 0);
      }

      return bandedTax(price, standardBands, 0);
    }

    function calculate() {
      clearError("price");
      const price = parseNumber(fields.price);
      const buyerType = fields.buyerType?.value ?? "standard";

      if (price === null || price <= 0) {
        showError("price", "Enter a property price greater than 0.");
        setBlankResults();
        fields.price?.focus();
        return;
      }

      const sdlt = calculateSdlt(price, buyerType);
      const effectiveRate = (sdlt / price) * 100;

      document.getElementById("sdlt").textContent = fmtGBP.format(sdlt);
      document.getElementById("rate").textContent = `${fmtPct.format(effectiveRate)}%`;
      document.getElementById("total").textContent = fmtGBP.format(price + sdlt);
    }

    function reset() {
      fields.price.value = "";
      fields.buyerType.value = "standard";
      clearError("price");
      setBlankResults();
      fields.price?.focus();
    }

    fields.price?.addEventListener("input", () => clearError("price"));

    const calcBtn = document.getElementById("calcBtn");
    const calcLabel = calcBtn?.querySelector("[data-calc-label]");
    const calcSpinner = calcBtn?.querySelector("[data-calc-spinner]");

    function setLoading(isLoading) {
      if (!calcBtn) return;
      calcBtn.disabled = isLoading;
      calcBtn.setAttribute("aria-busy", isLoading ? "true" : "false");
      calcBtn.classList.toggle("opacity-70", isLoading);
      calcBtn.classList.toggle("cursor-not-allowed", isLoading);
      calcSpinner?.classList.toggle("hidden", !isLoading);
      calcLabel?.classList.toggle("sr-only", isLoading);
    }

    calcBtn?.addEventListener("click", () => {
      if (calcBtn.disabled) return;
      setLoading(true);
      window.setTimeout(() => {
        calculate();
        setLoading(false);
      }, 1000);
    });
    document.getElementById("resetBtn")?.addEventListener("click", reset);

    setBlankResults();
  </script>
</Layout>
