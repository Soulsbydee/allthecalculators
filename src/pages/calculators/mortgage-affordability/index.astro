---
import Layout from "../../../layouts/Layout.astro";
import Card from "../../../components/Card.astro";
import Input from "../../../components/Input.astro";
import Button from "../../../components/Button.astro";

const title = "Mortgage affordability calculator (UK) — All The Calculators";
const description =
  "Estimate how much you might be able to borrow for a mortgage based on income and a borrowing multiple.";
---

<Layout title={title} description={description}>
  <div class="space-y-6">
    <div>
      <h1 class="text-2xl font-semibold tracking-tight">Mortgage affordability</h1>
      <p class="mt-2 text-sm text-[rgb(var(--muted))]">
        Enter your income (and a deposit if you have one) to estimate a maximum mortgage and property price.
        This is a simple estimate and different lenders may use different criteria.
      </p>
    </div>

    <!-- Inputs (no bounding card) -->
    <section class="inputs-container space-y-4" aria-label="Mortgage affordability inputs">
      <div class="inputs-grid">
        <div>
          <Input
            id="income1"
            label="Annual income (£)"
            type="number"
            inputmode="decimal"
            min="0"
            step="1"
            placeholder="e.g. 55,000"
          />
          <p id="income1-error" class="mt-1 hidden text-xs text-red-600"></p>
        </div>

        <div>
          <div class="flex items-baseline justify-between gap-2">
            <span class="text-sm font-medium text-[rgb(var(--text))]">Second income (£)</span>
            <span class="text-xs text-[rgb(var(--muted))]">Optional</span>
          </div>
          <Input
            id="income2"
            label=""
            type="number"
            inputmode="decimal"
            min="0"
            step="1"
            placeholder="e.g. 35,000"
          />
          <p id="income2-error" class="mt-1 hidden text-xs text-red-600"></p>
        </div>

        <div>
          <div class="flex items-baseline justify-between gap-2">
            <span class="text-sm font-medium text-[rgb(var(--text))]">Borrowing multiple</span>
            <span class="text-xs text-[rgb(var(--muted))]">e.g. 4 to 4.5×</span>
          </div>
          <Input
            id="multiple"
            label=""
            type="number"
            inputmode="decimal"
            min="1"
            step="0.1"
            placeholder="e.g. 4.5"
          />
          <p id="multiple-error" class="mt-1 hidden text-xs text-red-600"></p>
        </div>

        <div>
          <div class="flex items-baseline justify-between gap-2">
            <span class="text-sm font-medium text-[rgb(var(--text))]">Deposit (£)</span>
            <span class="text-xs text-[rgb(var(--muted))]">Optional</span>
          </div>
          <Input
            id="deposit"
            label=""
            type="number"
            inputmode="decimal"
            min="0"
            step="1"
            placeholder="e.g. 30,000"
          />
          <p id="deposit-error" class="mt-1 hidden text-xs text-red-600"></p>
        </div>
      </div>

      <div class="flex flex-wrap gap-3 pt-1">
        <Button type="button" id="calcBtn">Calculate</Button>
        <Button type="button" variant="ghost" id="resetBtn">Reset</Button>
      </div>

      <p class="text-xs text-[rgb(var(--muted))]">
        We estimate borrowing as (total income × borrowing multiple). Use this as a guide, not a guarantee.
      </p>
    </section>

    <!-- Divider -->
    <hr class="border-t border-[rgb(var(--border))]" />

    <!-- Results (NO tinted wrapper) -->
    <section aria-label="Mortgage affordability results" class="space-y-4">
      <header>
        <h2 class="text-[18px] font-semibold tracking-tight">Results</h2>
        <p class="mt-1 text-[14px] text-[rgb(var(--muted))]">
          These are estimates based on your inputs.
        </p>
      </header>

      <div class="results-grid" role="status" aria-live="polite" aria-atomic="true">
        <Card>
          <div class="text-xs font-medium uppercase tracking-wide text-[rgb(var(--muted))]">
            Maximum mortgage
          </div>
          <div class="mt-1 text-[18px] font-semibold tracking-tight" id="maxMortgage">—</div>
          <div class="mt-1 text-xs text-[rgb(var(--muted))]">
            Based on income × borrowing multiple
          </div>
        </Card>

        <Card>
          <div class="text-xs font-medium uppercase tracking-wide text-[rgb(var(--muted))]">
            Maximum property price
          </div>
          <div class="mt-1 text-[18px] font-semibold tracking-tight" id="maxPrice">—</div>
          <div class="mt-1 text-xs text-[rgb(var(--muted))]">
            Maximum mortgage + deposit
          </div>
        </Card>

        <Card>
          <div class="text-xs font-medium uppercase tracking-wide text-[rgb(var(--muted))]">
            Total income
          </div>
          <div class="mt-1 text-[18px] font-semibold tracking-tight" id="totalIncome">—</div>
          <div class="mt-1 text-xs text-[rgb(var(--muted))]">
            Combined annual income
          </div>
        </Card>
      </div>
    </section>

    <!-- Divider -->
    <hr class="border-t border-[rgb(var(--border))]" />

    <!-- How it works (accordion, SF-style SVG chevron on left) -->
    <section class="max-w-2xl" aria-label="How this calculator works">
      <details class="group">
        <summary
          class="flex cursor-pointer list-none items-center gap-2 py-2 text-sm font-semibold tracking-tight focus:outline-none focus-visible:ring-2 focus-visible:ring-black/20 rounded-lg"
        >
          <span
            class="inline-flex h-4 w-4 items-center justify-center text-[rgb(var(--muted))] transition-transform group-open:rotate-90"
            aria-hidden="true"
          >
            <svg
              viewBox="0 0 20 20"
              width="16"
              height="16"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M7.25 4.75L12.75 10L7.25 15.25"
                stroke="currentColor"
                stroke-width="1.75"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
          </span>

          <span>How this calculator works</span>
        </summary>

        <div class="pt-2 pl-6 text-sm text-[rgb(var(--muted))]">
          <p>
            We estimate your maximum mortgage by multiplying your total annual income by a borrowing multiple.
            We then add your deposit (if provided) to estimate a maximum property price.
          </p>
          <p class="mt-2">
            This is a simple estimate. Real affordability depends on lender criteria, interest rates, your credit history,
            and monthly commitments (such as loans, credit cards, childcare, and other outgoings).
          </p>
        </div>
      </details>
    </section>
  </div>

  <script is:inline>
    const fmtGBP0 = new Intl.NumberFormat("en-GB", {
      style: "currency",
      currency: "GBP",
      maximumFractionDigits: 0,
    });

    const LIMITS = {
      incomeMax: 5_000_000,
      depositMax: 50_000_000,
      multipleMin: 1.0,
      multipleMax: 6.0,
    };

    const fields = {
      income1: document.getElementById("income1"),
      income2: document.getElementById("income2"),
      multiple: document.getElementById("multiple"),
      deposit: document.getElementById("deposit"),
    };

    const errors = {
      income1: document.getElementById("income1-error"),
      income2: document.getElementById("income2-error"),
      multiple: document.getElementById("multiple-error"),
      deposit: document.getElementById("deposit-error"),
    };

    function setBlankResults() {
      document.getElementById("maxMortgage").textContent = "—";
      document.getElementById("maxPrice").textContent = "—";
      document.getElementById("totalIncome").textContent = "—";
    }

    function showError(key, msg) {
      const input = fields[key];
      const err = errors[key];
      if (!input || !err) return;

      input.setAttribute("aria-invalid", "true");
      input.setAttribute("aria-describedby", `${key}-error`);
      input.classList.add("border-red-500");

      err.textContent = msg;
      err.classList.remove("hidden");
    }

    function clearError(key) {
      const input = fields[key];
      const err = errors[key];
      if (!input || !err) return;

      input.removeAttribute("aria-invalid");
      if (input.getAttribute("aria-describedby") === `${key}-error`) {
        input.removeAttribute("aria-describedby");
      }
      input.classList.remove("border-red-500");

      err.textContent = "";
      err.classList.add("hidden");
    }

    function parseNumber(el) {
      if (!el) return null;
      const v = String(el.value ?? "").trim();
      if (v === "") return null;
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    }

    function validate() {
      let firstInvalid = null;

      ["income1","income2","multiple","deposit"].forEach(clearError);

      const income1 = parseNumber(fields.income1);
      const income2 = parseNumber(fields.income2);
      const multiple = parseNumber(fields.multiple);
      const deposit = parseNumber(fields.deposit);

      if (income1 === null) {
        showError("income1", "Enter your annual income.");
        firstInvalid ??= fields.income1;
      } else if (income1 <= 0) {
        showError("income1", "Income must be greater than 0.");
        firstInvalid ??= fields.income1;
      } else if (income1 > LIMITS.incomeMax) {
        showError("income1", "That income looks unusually high.");
        firstInvalid ??= fields.income1;
      }

      if (income2 !== null) {
        if (income2 < 0) {
          showError("income2", "Second income cannot be negative.");
          firstInvalid ??= fields.income2;
        } else if (income2 > LIMITS.incomeMax) {
          showError("income2", "That income looks unusually high.");
          firstInvalid ??= fields.income2;
        }
      }

      if (multiple === null) {
        showError("multiple", "Enter a borrowing multiple (e.g. 4.5).");
        firstInvalid ??= fields.multiple;
      } else if (multiple < LIMITS.multipleMin || multiple > LIMITS.multipleMax) {
        showError("multiple", "Enter a realistic borrowing multiple (e.g. 4 to 4.5).");
        firstInvalid ??= fields.multiple;
      }

      if (deposit !== null) {
        if (deposit < 0) {
          showError("deposit", "Deposit cannot be negative.");
          firstInvalid ??= fields.deposit;
        } else if (deposit > LIMITS.depositMax) {
          showError("deposit", "That deposit looks unusually high.");
          firstInvalid ??= fields.deposit;
        }
      }

      return {
        valid: !firstInvalid,
        firstInvalid,
        income1,
        income2: income2 ?? 0,
        multiple,
        deposit: deposit ?? 0,
      };
    }

    function calculate() {
      const v = validate();
      if (!v.valid) {
        setBlankResults();
        v.firstInvalid?.focus();
        return;
      }

      const totalIncome = v.income1 + v.income2;
      const maxMortgage = totalIncome * v.multiple;
      const maxPrice = maxMortgage + v.deposit;

      document.getElementById("totalIncome").textContent = fmtGBP0.format(totalIncome);
      document.getElementById("maxMortgage").textContent = fmtGBP0.format(maxMortgage);
      document.getElementById("maxPrice").textContent = fmtGBP0.format(maxPrice);
    }

    function reset() {
      ["income1","income2","multiple","deposit"].forEach((k) => {
        const el = fields[k];
        if (el) el.value = "";
        clearError(k);
      });
      setBlankResults();
      fields.income1?.focus();
    }

    ["income1","income2","multiple","deposit"].forEach((k) => {
      fields[k]?.addEventListener("input", () => clearError(k));
    });

    const calcBtn = document.getElementById("calcBtn");
    const calcLabel = calcBtn?.querySelector("[data-calc-label]");
    const calcSpinner = calcBtn?.querySelector("[data-calc-spinner]");

    function setLoading(isLoading) {
      if (!calcBtn) return;
      calcBtn.disabled = isLoading;
      calcBtn.setAttribute("aria-busy", isLoading ? "true" : "false");
      calcBtn.classList.toggle("opacity-70", isLoading);
      calcBtn.classList.toggle("cursor-not-allowed", isLoading);
      calcSpinner?.classList.toggle("hidden", !isLoading);
      calcLabel?.classList.toggle("sr-only", isLoading);
    }

    calcBtn?.addEventListener("click", () => {
      if (calcBtn.disabled) return;
      setLoading(true);
      window.setTimeout(() => {
        calculate();
        setLoading(false);
      }, 1000);
    });
    document.getElementById("resetBtn")?.addEventListener("click", reset);

    setBlankResults();
  </script>
</Layout>
