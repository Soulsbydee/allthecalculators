---
import Layout from "../../../layouts/Layout.astro";
import Card from "../../../components/Card.astro";
import Input from "../../../components/Input.astro";
import Button from "../../../components/Button.astro";

const title = "Savings goal calculator (UK) — All The Calculators";
const description =
  "Work out how much you need to save each month to reach a savings goal over time.";
---

<Layout title={title} description={description}>
  <div class="space-y-6">
    <div>
      <h1 class="text-2xl font-semibold tracking-tight">Savings goal</h1>
      <p class="mt-2 text-sm text-[rgb(var(--muted))]">
        Enter your savings goal and time period to see how much you need to save each month.
        If the monthly amount feels too high, try increasing the time period or starting balance.
      </p>
    </div>

    <!-- Inputs -->
    <section class="inputs-container space-y-4" aria-label="Savings goal inputs">
      <div class="inputs-grid">
        <div>
          <Input
            id="goal"
            label="Target amount (£)"
            type="number"
            inputmode="decimal"
            min="0"
            step="0.01"
            placeholder="e.g. 20,000"
          />
          <p id="goal-error" class="mt-1 hidden text-xs text-red-600"></p>
        </div>

        <div>
          <Input
            id="start"
            label="Starting balance (£)"
            type="number"
            inputmode="decimal"
            min="0"
            step="0.01"
            placeholder="e.g. 2,000"
          />
          <p id="start-error" class="mt-1 hidden text-xs text-red-600"></p>
        </div>

        <div>
          <Input
            id="rate"
            label="Interest rate (%)"
            type="number"
            inputmode="decimal"
            min="0"
            step="0.01"
            placeholder="e.g. 4.0"
          />
          <p id="rate-error" class="mt-1 hidden text-xs text-red-600"></p>
        </div>

        <div>
          <Input
            id="years"
            label="Time period (years)"
            type="number"
            inputmode="numeric"
            min="1"
            step="1"
            placeholder="e.g. 5"
          />
          <p id="years-error" class="mt-1 hidden text-xs text-red-600"></p>
        </div>
      </div>

      <div class="flex flex-wrap gap-3 pt-1">
        <Button type="button" id="calcBtn">Calculate</Button>
        <Button type="button" variant="ghost" id="resetBtn">Reset</Button>
      </div>

      <p class="text-xs text-[rgb(var(--muted))]">
        This calculator works out the monthly amount needed to reach your goal.
        If you already save a fixed amount, you can use the Savings growth calculator instead.
      </p>
    </section>

    <!-- Divider -->
    <hr class="border-t border-[rgb(var(--border))]" />

    <!-- Results (NO tinted wrapper) -->
    <section aria-label="Savings goal results" class="space-y-4">
      <header>
        <h2 class="text-[18px] font-semibold tracking-tight">Results</h2>
        <p class="mt-1 text-[14px] text-[rgb(var(--muted))]">
          These are estimates based on your inputs.
        </p>
      </header>

      <div class="results-grid" role="status" aria-live="polite" aria-atomic="true">
        <Card>
          <div class="text-xs font-medium uppercase tracking-wide text-[rgb(var(--muted))]">
            Monthly contribution
          </div>
          <div class="mt-1 text-[18px] font-semibold tracking-tight" id="monthly">—</div>
          <div class="mt-1 text-xs text-[rgb(var(--muted))]">
            Amount to save each month to reach your goal
          </div>
        </Card>

        <Card>
          <div class="text-xs font-medium uppercase tracking-wide text-[rgb(var(--muted))]">
            Total contributed
          </div>
          <div class="mt-1 text-[18px] font-semibold tracking-tight" id="contrib">—</div>
          <div class="mt-1 text-xs text-[rgb(var(--muted))]">
            Starting balance + contributions
          </div>
        </Card>

        <Card>
          <div class="text-xs font-medium uppercase tracking-wide text-[rgb(var(--muted))]">
            Interest earned
          </div>
          <div class="mt-1 text-[18px] font-semibold tracking-tight" id="interest">—</div>
          <div class="mt-1 text-xs text-[rgb(var(--muted))]">
            Growth from interest
          </div>
        </Card>
      </div>
    </section>

    <!-- Divider -->
    <hr class="border-t border-[rgb(var(--border))]" />

    <!-- How it works (accordion, SF-style SVG chevron on left) -->
    <section class="max-w-2xl" aria-label="How this calculator works">
      <details class="group">
        <summary
          class="flex cursor-pointer list-none items-center gap-2 py-2 text-sm font-semibold tracking-tight focus:outline-none focus-visible:ring-2 focus-visible:ring-black/20 rounded-lg"
        >
          <span
            class="inline-flex h-4 w-4 items-center justify-center text-[rgb(var(--muted))] transition-transform group-open:rotate-90"
            aria-hidden="true"
          >
            <svg
              viewBox="0 0 20 20"
              width="16"
              height="16"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M7.25 4.75L12.75 10L7.25 15.25"
                stroke="currentColor"
                stroke-width="1.75"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
          </span>

          <span>How this calculator works</span>
        </summary>

        <div class="pt-2 pl-6 text-sm text-[rgb(var(--muted))]">
          <p>
            We calculate the monthly contribution required to reach your target amount by the end of the chosen time period.
          </p>
          <p class="mt-2">
            The calculation assumes monthly contributions, a fixed annual interest rate, and no withdrawals during the period.
          </p>
          <p class="mt-2">
            If you prefer to save a fixed monthly amount and see how long it might take, try the Savings growth calculator.
          </p>
        </div>
      </details>
    </section>
  </div>

  <script is:inline>
    const fmtGBP2 = new Intl.NumberFormat("en-GB", { style: "currency", currency: "GBP" });

    const fields = {
      goal: document.getElementById("goal"),
      start: document.getElementById("start"),
      rate: document.getElementById("rate"),
      years: document.getElementById("years"),
    };

    const errors = {
      goal: document.getElementById("goal-error"),
      start: document.getElementById("start-error"),
      rate: document.getElementById("rate-error"),
      years: document.getElementById("years-error"),
    };

    function setBlankResults() {
      document.getElementById("monthly").textContent = "—";
      document.getElementById("contrib").textContent = "—";
      document.getElementById("interest").textContent = "—";
    }

    function showError(key, msg) {
      const input = fields[key];
      const err = errors[key];
      if (!input || !err) return;
      input.setAttribute("aria-invalid", "true");
      input.setAttribute("aria-describedby", `${key}-error`);
      input.classList.add("border-red-500");
      err.textContent = msg;
      err.classList.remove("hidden");
    }

    function clearError(key) {
      const input = fields[key];
      const err = errors[key];
      if (!input || !err) return;
      input.removeAttribute("aria-invalid");
      if (input.getAttribute("aria-describedby") === `${key}-error`) input.removeAttribute("aria-describedby");
      input.classList.remove("border-red-500");
      err.textContent = "";
      err.classList.add("hidden");
    }

    function parseNumber(el) {
      const v = String(el?.value ?? "").trim();
      if (v === "") return null;
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    }

    function validate() {
      ["goal","start","rate","years"].forEach(clearError);
      let firstInvalid = null;

      const goal = parseNumber(fields.goal);
      const start = parseNumber(fields.start);
      const rate = parseNumber(fields.rate);
      const years = parseNumber(fields.years);

      if (goal === null || goal <= 0) {
        showError("goal", "Enter a target amount greater than 0.");
        firstInvalid ??= fields.goal;
      }
      if (start === null || start < 0) {
        showError("start", "Enter a starting balance (0 or more).");
        firstInvalid ??= fields.start;
      }
      if (rate === null || rate < 0 || rate > 200) {
        showError("rate", "Enter an interest rate between 0 and 200%.");
        firstInvalid ??= fields.rate;
      }
      if (years === null || years <= 0 || !Number.isInteger(years)) {
        showError("years", "Enter a time period in whole years (at least 1).");
        firstInvalid ??= fields.years;
      }

      return { valid: !firstInvalid, firstInvalid, goal, start, rate, years };
    }

    function calculate() {
      const v = validate();
      if (!v.valid) {
        setBlankResults();
        v.firstInvalid?.focus();
        return;
      }

      const months = v.years * 12;
      const r = (v.rate / 100) / 12;

      // Solve for monthly contribution needed to reach goal
      // Future value with starting balance + contributions (paid end of period)
      // FV = start*(1+r)^n + m * [((1+r)^n - 1)/r]
      // m = (FV - start*(1+r)^n) * r / ((1+r)^n - 1)
      let monthly = 0;

      const growth = Math.pow(1 + r, months);
      if (r === 0) {
        monthly = (v.goal - v.start) / months;
      } else {
        monthly = (v.goal - v.start * growth) * r / (growth - 1);
      }

      // If start already meets/exceeds goal, monthly is 0
      if (!Number.isFinite(monthly) || monthly < 0) monthly = 0;

      // Simulate to produce contributed/interest breakdown
      let balance = v.start;
      let contributed = v.start;

      for (let i = 0; i < months; i++) {
        balance = balance * (1 + r) + monthly;
        contributed += monthly;
      }

      const interest = balance - contributed;

      document.getElementById("monthly").textContent = fmtGBP2.format(monthly);
      document.getElementById("contrib").textContent = fmtGBP2.format(contributed);
      document.getElementById("interest").textContent = fmtGBP2.format(interest);
    }

    function reset() {
      ["goal","start","rate","years"].forEach((k) => {
        fields[k].value = "";
        clearError(k);
      });
      setBlankResults();
      fields.goal?.focus();
    }

    ["goal","start","rate","years"].forEach((k) => fields[k]?.addEventListener("input", () => clearError(k)));

    document.getElementById("calcBtn")?.addEventListener("click", calculate);
    document.getElementById("resetBtn")?.addEventListener("click", reset);

    setBlankResults();
  </script>
</Layout>