---
import Layout from "../../../layouts/Layout.astro";
import Card from "../../../components/Card.astro";
import Input from "../../../components/Input.astro";
import Button from "../../../components/Button.astro";

const title = "Inheritance tax calculator (UK) — All The Calculators";
const description =
  "Estimate UK inheritance tax (IHT) using estate value, liabilities, and available nil-rate bands.";
---

<Layout title={title} description={description}>
  <div class="space-y-6">
    <header>
      <h1 class="text-2xl font-semibold tracking-tight">Inheritance tax</h1>
      <p class="mt-2 text-sm text-[rgb(var(--muted))] max-w-2xl">
        Estimate inheritance tax (IHT) on an estate using simplified UK nil-rate band assumptions.
      </p>
    </header>

    <section class="inputs-container space-y-4" aria-label="Inheritance tax inputs">
      <div class="inputs-grid">
        <Input id="estate" label="Gross estate value (£)" type="number" inputmode="decimal" min="0" step="1" placeholder="e.g. 850000" />
        <Input id="liabilities" label="Debts & deductible costs (£)" type="number" inputmode="decimal" min="0" step="1" placeholder="Optional" />
        <Input id="gifts" label="Chargeable lifetime gifts (£)" type="number" inputmode="decimal" min="0" step="1" placeholder="Optional" />

        <div>
          <label for="residenceBand" class="mb-1 block text-sm font-medium text-[rgb(var(--text))]">Residence nil-rate band</label>
          <select id="residenceBand" class="w-full rounded-xl border border-[rgb(var(--border))] bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-black/10">
            <option value="yes" selected>Include (simplified)</option>
            <option value="no">Exclude</option>
          </select>
        </div>

        <div>
          <label for="spouseExempt" class="mb-1 block text-sm font-medium text-[rgb(var(--text))]">Spouse/civil partner exemption</label>
          <select id="spouseExempt" class="w-full rounded-xl border border-[rgb(var(--border))] bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-black/10">
            <option value="no" selected>No</option>
            <option value="yes">Yes (full exemption)</option>
          </select>
        </div>
      </div>

      <p id="form-error" class="hidden text-xs text-red-600"></p>

      <div class="flex flex-wrap gap-3 pt-1">
        <Button type="button" id="calcBtn">Calculate</Button>
        <Button type="button" variant="ghost" id="resetBtn">Reset</Button>
      </div>
    </section>

    <hr class="border-t border-[rgb(var(--border))]" />

    <section aria-label="Inheritance tax results" class="space-y-4">
      <header>
        <h2 class="text-[18px] font-semibold tracking-tight">Results</h2>
        <p class="mt-1 text-[14px] text-[rgb(var(--muted))]">These are estimates based on your inputs.</p>
      </header>
      <div class="results-grid" role="status" aria-live="polite" aria-atomic="true">
        <Card>
          <div class="text-xs font-medium uppercase tracking-wide text-[rgb(var(--muted))]">Taxable estate</div>
          <div class="mt-1 text-[18px] font-semibold tracking-tight" id="taxable">—</div>
        </Card>
        <Card>
          <div class="text-xs font-medium uppercase tracking-wide text-[rgb(var(--muted))]">Estimated IHT</div>
          <div class="mt-1 text-[18px] font-semibold tracking-tight" id="iht">—</div>
        </Card>
        <Card>
          <div class="text-xs font-medium uppercase tracking-wide text-[rgb(var(--muted))]">Effective tax rate</div>
          <div class="mt-1 text-[18px] font-semibold tracking-tight" id="rate">—</div>
        </Card>
      </div>
    </section>

    <hr class="border-t border-[rgb(var(--border))]" />

    <section class="max-w-2xl space-y-6" aria-label="Inheritance tax guide">
      <div>
        <h2 class="text-[18px] font-semibold tracking-tight">What this calculator does</h2>
        <p class="mt-2 text-sm text-[rgb(var(--muted))]">
          This calculator estimates UK inheritance tax based on estate value and simplified nil-rate band assumptions.
        </p>
      </div>
      <div>
        <h2 class="text-[18px] font-semibold tracking-tight">How the formula works</h2>
        <p class="mt-2 text-sm text-[rgb(var(--muted))]">
          Net estate is gross estate minus liabilities, plus chargeable gifts entered. We then subtract available
          nil-rate bands and apply 40% IHT to the taxable amount.
        </p>
      </div>
      <div>
        <h2 class="text-[18px] font-semibold tracking-tight">Important limitations</h2>
        <ul class="mt-2 list-disc pl-5 text-sm text-[rgb(var(--muted))] space-y-1">
          <li>Simplified model only: no taper relief or full gift timing rules.</li>
          <li>Residence nil-rate band has detailed conditions not fully modelled.</li>
          <li>No trust planning or business/agricultural relief modelling.</li>
        </ul>
      </div>
      <div>
        <h2 class="text-[18px] font-semibold tracking-tight">Related calculators</h2>
        <ul class="mt-2 list-disc pl-5 text-sm text-[rgb(var(--muted))] space-y-1">
          <li><a class="underline" href="/calculators/savings-goal">Savings goal calculator</a></li>
          <li><a class="underline" href="/calculators/compound-interest">Compound interest calculator</a></li>
          <li><a class="underline" href="/calculators/net-to-gross-salary">Net to gross salary calculator</a></li>
        </ul>
      </div>
    </section>
  </div>

  <script is:inline>
    const NRB = 325000;
    const RNRB = 175000;
    const IHT_RATE = 0.40;

    const fmtGBP = new Intl.NumberFormat("en-GB", { style: "currency", currency: "GBP" });
    const fmtPct = new Intl.NumberFormat("en-GB", { maximumFractionDigits: 2 });

    const ids = ["estate", "liabilities", "gifts"];
    const formError = document.getElementById("form-error");

    function parseNum(id) {
      const n = Number(document.getElementById(id).value || 0);
      return Number.isFinite(n) ? n : 0;
    }

    function setBlankResults() {
      document.getElementById("taxable").textContent = "—";
      document.getElementById("iht").textContent = "—";
      document.getElementById("rate").textContent = "—";
    }

    function setError(msg) {
      formError.textContent = msg;
      formError.classList.remove("hidden");
    }

    function clearError() {
      formError.textContent = "";
      formError.classList.add("hidden");
    }

    function calculate() {
      clearError();

      const estate = parseNum("estate");
      const liabilities = parseNum("liabilities");
      const gifts = parseNum("gifts");
      const includeRNRB = document.getElementById("residenceBand").value === "yes";
      const spouseExempt = document.getElementById("spouseExempt").value === "yes";

      if (estate <= 0) {
        setError("Enter a gross estate value greater than 0.");
        setBlankResults();
        return;
      }
      if (liabilities < 0 || gifts < 0) {
        setError("Enter liabilities and gifts as 0 or more.");
        setBlankResults();
        return;
      }

      if (spouseExempt) {
        document.getElementById("taxable").textContent = fmtGBP.format(0);
        document.getElementById("iht").textContent = fmtGBP.format(0);
        document.getElementById("rate").textContent = "0%";
        return;
      }

      const netEstate = Math.max(0, estate - liabilities) + gifts;
      const bands = NRB + (includeRNRB ? RNRB : 0);
      const taxable = Math.max(0, netEstate - bands);
      const iht = taxable * IHT_RATE;
      const effectiveRate = estate > 0 ? (iht / estate) * 100 : 0;

      document.getElementById("taxable").textContent = fmtGBP.format(taxable);
      document.getElementById("iht").textContent = fmtGBP.format(iht);
      document.getElementById("rate").textContent = `${fmtPct.format(effectiveRate)}%`;
    }

    function reset() {
      ids.forEach((id) => { document.getElementById(id).value = ""; });
      document.getElementById("residenceBand").value = "yes";
      document.getElementById("spouseExempt").value = "no";
      clearError();
      setBlankResults();
      document.getElementById("estate")?.focus();
    }

    const calcBtn = document.getElementById("calcBtn");
    const calcLabel = calcBtn?.querySelector("[data-calc-label]");
    const calcSpinner = calcBtn?.querySelector("[data-calc-spinner]");
    function setLoading(isLoading) {
      if (!calcBtn) return;
      calcBtn.disabled = isLoading;
      calcBtn.setAttribute("aria-busy", isLoading ? "true" : "false");
      calcBtn.classList.toggle("opacity-70", isLoading);
      calcBtn.classList.toggle("cursor-not-allowed", isLoading);
      calcSpinner?.classList.toggle("hidden", !isLoading);
      calcLabel?.classList.toggle("sr-only", isLoading);
    }

    calcBtn?.addEventListener("click", () => {
      if (calcBtn.disabled) return;
      setLoading(true);
      window.setTimeout(() => {
        calculate();
        setLoading(false);
      }, 1000);
    });
    document.getElementById("resetBtn")?.addEventListener("click", reset);
    setBlankResults();
  </script>
</Layout>
